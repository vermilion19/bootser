# 🏛️ Waiting Service 기능 명세서

## 1. 핵심 기능 (Core Features)

### 1️⃣ 대기열 등록 (Register)
손님이 식당에 줄을 서는 가장 기초적이고 중요한 기능입니다.
- **중복 검증:** 동일한 식당에 동일한 전화번호로 중복 등록 불가 (이미 `WAITING` 상태인 경우).
- **대기 번호 발급 (Numbering):** - 단순 전체 카운트가 아닌, **"식당별 + 당일"** 기준의 순차적인 번호(1, 2, 3...)를 발급해야 함.
    - 동시성 이슈 발생 시 번호가 건너뛰거나 중복되지 않아야 함.
- **유효성 체크:**
    - 식당 영업 상태 확인.
    - 대기열 마감(Sold Out) 여부 확인.

### 2️⃣ 내 대기 상태 조회 (Get My Rank)
손님이 본인의 현재 순서를 실시간으로 확인합니다.
- **내 순번 계산:** - `(내 번호) - (현재 입장 번호)` 방식은 취소된 사람을 계산 못 함.
    - **실제 내 앞의 `WAITING` 상태 인원 수**를 정확히 카운트해야 함.
- **예상 대기 시간:** (Optional) `내 앞 팀 수 * 식당별 평균 식사 시간` 제공.

### 3️⃣ 입장 처리 (Mark as Entered)
점주가 손님을 호출하고 실제로 매장에 들어왔을 때 처리합니다.
- **상태 변경:** `WAITING` -> `ENTERED`
- **검증:** 이미 취소(`CANCELED`)되었거나 만료된 토큰은 입장 처리 불가.

### 4️⃣ 대기 취소 (Cancel)
대기열에서 이탈하는 경우입니다. 주체에 따라 사유가 다를 수 있습니다.
- **손님 취소:** 단순 변심 등으로 직접 취소.
- **점주 취소 (노쇼/거절):** 호명했으나 부재중일 경우, 재료 소진 등.
- **상태 변경:** `WAITING` -> `CANCELED`

### 5️⃣ 순서 미루기 (Postpone) - ⭐ Killer Feature
"지금 당장 못 갈 것 같아요, 맨 뒤로 미뤄주세요."
- **로직:** 1. 현재 대기표를 `CANCELED` 처리.
    2. 새로운 대기표를 발급하되, 맨 마지막 순번 부여.
    3. (심화) 특정 순서 뒤로 끼워넣기 (구현 난이도 높음, 초기엔 맨 뒤로 가기 권장).

### 6️⃣ 점주용 대기 현황 (Owner View)
매장 태블릿에서 볼 관리자 화면입니다.
- **목록 조회:** 현재 `WAITING` 상태인 팀들을 대기 번호순(오름차순)으로 정렬하여 반환.

---

## 2. 설계 및 구현 시 고려사항 (Key Considerations)

### 🚨 동시성 제어 (Concurrency Control) - 최우선 과제
대규모 트래픽 발생 시 가장 문제가 되는 지점입니다.
- **문제 상황:** 인기 식당 오픈 런 시, 100명이 동시에 누르면 100명이 전부 "대기번호 1번"을 받을 위험이 있음.
- **해결 방안:**
    - **DB Lock:** 비관적 락(`SELECT FOR UPDATE`) 또는 낙관적 락(`@Version`).
    - **Redis:** `INCR` 명령어를 통한 Atomic 번호 채번 (성능상 권장).
    - **Distributed Lock:** Redisson 등을 이용한 분산 락 적용.

### 🔄 대기 번호 초기화 (Reset Logic)
- **요구사항:** 어제 150번까지 대기가 있었어도, **오늘 영업 시작 시엔 1번부터** 다시 시작해야 함.
- **전략:**
    - DB 조회 시 날짜 조건(`created_at`)을 포함하여 `MAX(waiting_number)`를 구함.
    - Redis 키 전략을 `restaurant:1:20260104:count` 처럼 날짜별로 분리.

### 🧩 데이터 정합성 (Data Consistency)
- **트랜잭션 범위:** 대기열 등록 성공 후 -> 알림톡 발송 실패 시 어떻게 할 것인가? (Rollback vs Retry)
- **이벤트 발행:** Kafka로 "대기 등록됨" 이벤트를 발행하여, 알림 서비스나 통계 서비스와 결합도를 낮춤.

### 📊 성능 최적화 (Performance)
- **인덱스(Index):** `(restaurant_id, status, created_at)` 등 조회 패턴에 맞는 복합 인덱스 설계 필요.
- **캐싱(Caching):** "내 앞의 대기 팀 수"는 조회 빈도가 높으므로 Redis Caching 고려.