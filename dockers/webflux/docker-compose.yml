services:
  redis:
    image: redis:7-alpine
    container_name: webflux-redis
    ports:
      - "6380:6379"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - webflux-network

  chatting-service:
    build:
      context: ../../apps/webflux/chatting-service
      dockerfile: Dockerfile
    container_name: chatting-service
    ports:
      - "8082:8080"
    environment:
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
    depends_on:
      - redis
    ulimits:
      nofile:
        soft: 200000
        hard: 200000
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - webflux-network

  logstream-service:
    build:
      context: ../../apps/webflux/logstream-service
      dockerfile: Dockerfile
    container_name: logstream-service
    ports:
      - "8083:8081"
    volumes:
      - logstream-data:/app/logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - webflux-network

  attacker:
    build:
      context: ../../apps/webflux/chatting-service
      dockerfile: Dockerfile.attacker
    depends_on:
      - chatting-service
    environment:
      - TARGET_URL=ws://chatting-service:8080/ws/chat
      - CONN_COUNT=25000
    deploy:
      replicas: 4
      resources:
        limits:
          memory: 2G
    ulimits:
      nofile:
        soft: 60000
        hard: 60000
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - webflux-network

networks:
  webflux-network:
    driver: bridge

volumes:
  logstream-data:
