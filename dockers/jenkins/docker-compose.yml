networks:
  booster-network:
    external: true

volumes:
  jenkins-data:

services:
  jenkins:
    image: jenkins/jenkins:lts-jdk21
    container_name: booster-jenkins
    user: root
    privileged: true
    ports:
      - "9090:8080"
      - "50000:50000"
    volumes:
      - jenkins-data:/var/jenkins_home
      # Windows Docker Desktop: named pipe 사용
      - //var/run/docker.sock:/var/run/docker.sock
      # 프로젝트 루트 마운트 (빌드용)
      - ../..:/workspace/bootser
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - booster-network

  # Docker CLI 설치를 위한 초기화 컨테이너 (최초 1회만 실행)
  jenkins-docker-setup:
    image: docker:cli
    container_name: jenkins-docker-setup
    volumes:
      - jenkins-data:/var/jenkins_home
    command: >
      sh -c "cp /usr/local/bin/docker /var/jenkins_home/docker && chmod +x /var/jenkins_home/docker"
    profiles:
      - setup
