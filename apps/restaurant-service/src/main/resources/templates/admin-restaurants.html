<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì‹ë‹¹ ê´€ë¦¬ì í˜ì´ì§€</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn-action { width: 85px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">ğŸª ì‹ë‹¹ ê´€ë¦¬</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
            + ìƒˆ ì‹ë‹¹ ë“±ë¡
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle text-center">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>ì‹ë‹¹ ì´ë¦„</th>
                    <th>ìˆ˜ìš© ì¸ì›</th>
                    <th>ëŒ€ê¸° ì œí•œ</th>
                    <th>ì˜ì—… ìƒíƒœ</th>
                    <th>í˜„ì¬ ì¸ì›</th>
                    <th style="width: 400px;">ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody id="restaurantTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒˆ ì‹ë‹¹ ë“±ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label class="form-label">ì‹ë‹¹ ì´ë¦„</label>
                        <input type="text" id="regName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ìµœëŒ€ ìˆ˜ìš© ì¸ì›</label>
                        <input type="number" id="regCapacity" class="form-control" value="50" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ëŒ€ê¸°ì—´ ì œí•œ ìˆ˜</label>
                        <input type="number" id="regLimit" class="form-control" value="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="registerRestaurant()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‹ë‹¹ ì •ë³´ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label">ì‹ë‹¹ ì´ë¦„</label>
                        <input type="text" id="editName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ìµœëŒ€ ìˆ˜ìš© ì¸ì›</label>
                        <input type="number" id="editCapacity" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ëŒ€ê¸°ì—´ ì œí•œ ìˆ˜</label>
                        <input type="number" id="editLimit" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="updateRestaurant()">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = '/restaurants';

    document.addEventListener('DOMContentLoaded', loadRestaurants);

    // 1. ì „ì²´ ëª©ë¡ ì¡°íšŒ
    function loadRestaurants() {
        fetch(API_URL)
            .then(res => res.json())
            .then(response => {
                const list = response.data;
                const tbody = document.getElementById('restaurantTableBody');
                tbody.innerHTML = '';

                list.forEach(r => {
                    let statusBtn = '';
                    if (r.status === 'OPEN') {
                        statusBtn = `<button class="btn btn-sm btn-outline-danger btn-action me-1" onclick="toggleStatus(${r.id}, 'close')">â›” ì¢…ë£Œ</button>`;
                    } else {
                        statusBtn = `<button class="btn btn-sm btn-outline-success btn-action me-1" onclick="toggleStatus(${r.id}, 'open')">ğŸŸ¢ ì‹œì‘</button>`;
                    }

                    const row = `
                        <tr>
                            <td>${r.id}</td>
                            <td class="fw-bold">${r.name}</td>
                            <td>${r.capacity}ëª…</td>
                            <td>${r.maxWaitingLimit}íŒ€</td>
                            <td>
                                <span class="badge ${r.status === 'OPEN' ? 'bg-success' : 'bg-secondary'}">
                                    ${r.status}
                                </span>
                            </td>
                            <td class="text-primary fw-bold">${r.currentOccupancy}ëª…</td>
                            <td>
                                <div class="btn-group">
                                    ${statusBtn}
                                    <button class="btn btn-sm btn-primary btn-action me-1" onclick="handleOccupancy(${r.id}, 'entry')">ğŸ“¥ ì…ì¥</button>
                                    <button class="btn btn-sm btn-warning btn-action me-1 text-white" onclick="handleOccupancy(${r.id}, 'exit')">ğŸ“¤ í‡´ì¥</button>
                                    <button class="btn btn-sm btn-secondary btn-action" onclick="openEditModal(${r.id})">âœï¸ ìˆ˜ì •</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(err => {
                console.error(err);
                alert('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            });
    }

    // 2. ì…ì¥ ë° í‡´ì¥ ì²˜ë¦¬ (partySize ì…ë ¥ í¬í•¨)
    function handleOccupancy(id, action) {
        const actionName = action === 'entry' ? 'ì…ì¥' : 'í‡´ì¥';
        const partySize = prompt(`${actionName}í•˜ì‹¤ ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`, "1");

        if (partySize === null) return; // ì·¨ì†Œ í´ë¦­ ì‹œ

        if (isNaN(partySize) || partySize <= 0) {
            alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        // ê²½ë¡œ ì•ì— API_URL('/restaurants')ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        fetch(`${API_URL}/${id}/${action}?partySize=${partySize}`, {
            method: 'POST'
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    alert(`${actionName} ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadRestaurants(); // ëª©ë¡ ê°±ì‹ 
                } else {
                    // CoreException ë“±ì—ì„œ ë˜ì§„ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì¶œë ¥
                    alert(`ì‹¤íŒ¨: ${response.message}`);
                }
            })
            .catch(err => alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜'));
    }

    // 3. ì˜ì—… ìƒíƒœ ë³€ê²½
    function toggleStatus(id, action) {
        fetch(`${API_URL}/${id}/${action}`, {
            method: 'POST'
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    loadRestaurants();
                } else {
                    alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + response.message);
                }
            })
            .catch(err => alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜'));
    }

    // 4. ì‹ë‹¹ ë“±ë¡
    function registerRestaurant() {
        const data = {
            name: document.getElementById('regName').value,
            capacity: parseInt(document.getElementById('regCapacity').value),
            maxWaitingLimit: parseInt(document.getElementById('regLimit').value)
        };

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('ì‹¤íŒ¨: ' + response.message);
                }
            });
    }

    // 5. ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(id) {
        fetch(`${API_URL}/${id}`)
            .then(res => res.json())
            .then(response => {
                const data = response.data;
                document.getElementById('editId').value = data.id;
                document.getElementById('editName').value = data.name;
                document.getElementById('editCapacity').value = data.capacity;
                document.getElementById('editLimit').value = data.maxWaitingLimit;

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });
    }

    // 6. ì‹ë‹¹ ìˆ˜ì •
    function updateRestaurant() {
        const id = document.getElementById('editId').value;
        const data = {
            name: document.getElementById('editName').value,
            capacity: parseInt(document.getElementById('editCapacity').value),
            maxWaitingLimit: parseInt(document.getElementById('editLimit').value)
        };

        fetch(`${API_URL}/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('ìˆ˜ì • ì‹¤íŒ¨: ' + response.message);
                }
            });
    }
</script>
</body>
</html>