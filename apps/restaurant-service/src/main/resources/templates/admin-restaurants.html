<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>식당 관리자 페이지</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">🏪 식당 관리</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
            + 새 식당 등록
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>식당 이름</th>
                    <th>수용 인원</th>
                    <th>대기 제한</th>
                    <th>영업 상태</th>
                    <th>현재 인원</th>
                    <th style="width: 250px;">관리</th> </tr>
                </thead>
                <tbody id="restaurantTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 식당 등록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label class="form-label">식당 이름</label>
                        <input type="text" id="regName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">최대 수용 인원</label>
                        <input type="number" id="regCapacity" class="form-control" value="50" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">대기열 제한 수</label>
                        <input type="number" id="regLimit" class="form-control" value="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="registerRestaurant()">등록하기</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">식당 정보 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label">식당 이름</label>
                        <input type="text" id="editName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">최대 수용 인원</label>
                        <input type="number" id="editCapacity" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">대기열 제한 수</label>
                        <input type="number" id="editLimit" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" onclick="updateRestaurant()">수정 완료</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = '/restaurants'; // 같은 서버라고 가정

    // 페이지 로드 시 리스트 조회
    document.addEventListener('DOMContentLoaded', loadRestaurants);

    // 1. 전체 목록 조회 (GET /restaurants)
    function loadRestaurants() {
        fetch(API_URL)
            .then(res => res.json())
            .then(response => {
                const list = response.data;
                const tbody = document.getElementById('restaurantTableBody');
                tbody.innerHTML = ''; // 초기화

                list.forEach(r => {
                    // 상태에 따라 버튼 모양과 동작 결정 (동적 생성)
                    let statusBtn = '';
                    if (r.status === 'OPEN') {
                        // 영업 중이면 -> [영업 종료] 버튼 (빨간색)
                        statusBtn = `<button class="btn btn-sm btn-outline-danger me-2" onclick="toggleStatus(${r.id}, 'close')">⛔ 영업 종료</button>`;
                    } else {
                        // 닫혀 있으면 -> [영업 시작] 버튼 (초록색)
                        statusBtn = `<button class="btn btn-sm btn-outline-success me-2" onclick="toggleStatus(${r.id}, 'open')">🟢 영업 시작</button>`;
                    }

                    const row = `
                        <tr>
                            <td>${r.id}</td>
                            <td class="fw-bold">${r.name}</td>
                            <td>${r.capacity}명</td>
                            <td>${r.maxWaitingLimit}팀</td>
                            <td>
                                <span class="badge ${r.status === 'OPEN' ? 'bg-success' : 'bg-secondary'}">
                                    ${r.status}
                                </span>
                            </td>
                            <td>${r.currentOccupancy}명</td>
                            <td>
                                ${statusBtn}
                                <button class="btn btn-sm btn-primary" onclick="openEditModal(${r.id})">✏️ 수정</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(err => {
                console.error(err);
                alert('목록 로드 실패');
            });
    }

    // 2. 영업 상태 변경 (OPEN <-> CLOSED)
    function toggleStatus(id, action) {
        // action: 'open' or 'close'
        fetch(`${API_URL}/${id}/${action}`, {
            method: 'POST'
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    // 성공 시 목록만 새로고침 (페이지 리로드 없이 부드럽게)
                    loadRestaurants();
                } else {
                    alert('상태 변경 실패: ' + response.message);
                }
            })
            .catch(err => alert('서버 통신 오류'));
    }

    // 3. 식당 등록 (POST /restaurants)
    function registerRestaurant() {
        const data = {
            name: document.getElementById('regName').value,
            capacity: parseInt(document.getElementById('regCapacity').value),
            maxWaitingLimit: parseInt(document.getElementById('regLimit').value)
        };

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    alert('등록되었습니다.');
                    location.reload(); // 새로고침
                } else {
                    alert('실패: ' + response.message);
                }
            });
    }

    // 4. 수정 모달 열기 (단건 조회 GET /restaurants/{id})
    function openEditModal(id) {
        fetch(`${API_URL}/${id}`)
            .then(res => res.json())
            .then(response => {
                const data = response.data;
                // 폼에 값 채워넣기
                document.getElementById('editId').value = data.id;
                document.getElementById('editName').value = data.name;
                document.getElementById('editCapacity').value = data.capacity;
                document.getElementById('editLimit').value = data.maxWaitingLimit;

                // 모달 띄우기
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });
    }

    // 5. 식당 수정 (PATCH /restaurants/{id})
    function updateRestaurant() {
        const id = document.getElementById('editId').value;
        const data = {
            name: document.getElementById('editName').value,
            capacity: parseInt(document.getElementById('editCapacity').value),
            maxWaitingLimit: parseInt(document.getElementById('editLimit').value)
        };

        fetch(`${API_URL}/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(response => {
                if (response.result === 'SUCCESS') {
                    alert('수정되었습니다.');
                    location.reload();
                } else {
                    alert('수정 실패: ' + response.message);
                }
            });
    }
</script>
</body>
</html>